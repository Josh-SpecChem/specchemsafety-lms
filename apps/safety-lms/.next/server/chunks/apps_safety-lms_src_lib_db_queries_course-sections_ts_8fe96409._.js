module.exports=[52374,85348,99755,66685,e=>{"use strict";e.s(["createCourseSection",()=>g,"deleteCourseSection",()=>q,"getAccessibleCourseSections",()=>b,"getCourseSectionById",()=>a,"getCourseSectionByKey",()=>u,"getCourseSectionWithContent",()=>l,"getNextSectionOrderIndex",()=>w,"isSectionKeyUnique",()=>y,"updateCourseSection",()=>m],52374);var s=e.i(8079),t=e.i(56412),r=e.i(63519),o=e.i(89726);e.i(57354);var n=e.i(34565),c=e.i(73253),i=e.i(77209);let a=async e=>(await o.db.select().from(n.courseSections).where((0,s.eq)(n.courseSections.id,e)).limit(1))[0]||null,u=async(e,t)=>(await o.db.select().from(n.courseSections).where((0,s.and)((0,s.eq)(n.courseSections.courseId,e),(0,s.eq)(n.courseSections.sectionKey,t))).limit(1))[0]||null,d=async(e,r={})=>{let{includeUnpublished:c=!1,sortBy:i="orderIndex",sortOrder:a="asc"}=r,u=(0,s.eq)(n.courseSections.courseId,e);c||(u=(0,s.and)(u,(0,s.eq)(n.courseSections.isPublished,!0)));let d="desc"===a?(0,t.desc)(n.courseSections[i]):(0,t.asc)(n.courseSections[i]);return await o.db.select().from(n.courseSections).where(u).orderBy(d)},l=async e=>{let r=await a(e);return r?{section:r,contentBlocks:await o.db.select().from(c.contentBlocks).where((0,s.eq)(c.contentBlocks.sectionId,e)).orderBy((0,t.asc)(c.contentBlocks.orderIndex)),quizQuestions:await o.db.select().from(i.quizQuestions).where((0,s.eq)(i.quizQuestions.sectionId,e)).orderBy((0,t.asc)(i.quizQuestions.orderIndex))}:null},g=async e=>(await o.db.insert(n.courseSections).values(e).returning())[0],m=async(e,t)=>(await o.db.update(n.courseSections).set({...t,updatedAt:new Date}).where((0,s.eq)(n.courseSections.id,e)).returning())[0]||null,q=async e=>(await o.db.delete(n.courseSections).where((0,s.eq)(n.courseSections.id,e)).returning()).length>0,w=async e=>{let t=await o.db.select({maxOrder:r.sql`max(${n.courseSections.orderIndex})`}).from(n.courseSections).where((0,s.eq)(n.courseSections.courseId,e));return(t[0]?.maxOrder||0)+1},y=async(e,t,c)=>{let i=(0,s.and)((0,s.eq)(n.courseSections.courseId,e),(0,s.eq)(n.courseSections.sectionKey,t));return c&&(i=(0,s.and)(i,r.sql`${n.courseSections.id} != ${c}`)),0===(await o.db.select({id:n.courseSections.id}).from(n.courseSections).where(i).limit(1)).length},b=async(e,s,t={})=>{let{includeUnpublished:r=!1}=t;return"safety_admin"===s?d(e,{includeUnpublished:!0}):d(e,{includeUnpublished:r})};e.s(["createContentBlock",()=>p,"getContentBlocksBySectionId",()=>h,"getNextContentBlockOrderIndex",()=>S,"validateContentBlockContent",()=>A],85348);let h=async(e,r={})=>{let{blockType:n,sortBy:i="orderIndex",sortOrder:a="asc"}=r,u=(0,s.eq)(c.contentBlocks.sectionId,e);n&&(u=(0,s.and)(u,(0,s.eq)(c.contentBlocks.blockType,n)));let d="desc"===a?(0,t.desc)(c.contentBlocks[i]):(0,t.asc)(c.contentBlocks[i]);return await o.db.select().from(c.contentBlocks).where(u).orderBy(d)},p=async e=>(await o.db.insert(c.contentBlocks).values(e).returning())[0],S=async e=>{let t=await o.db.select({maxOrder:r.sql`max(${c.contentBlocks.orderIndex})`}).from(c.contentBlocks).where((0,s.eq)(c.contentBlocks.sectionId,e));return(t[0]?.maxOrder||0)+1},A=async(e,s)=>{let t=[];switch(e){case"hero":s.title||t.push("Hero blocks require a title");break;case"text":s.content||s.text||t.push("Text blocks require content or text");break;case"image":s.image?.url||t.push("Image blocks require an image URL");break;case"table":s.table?.headers&&s.table?.rows||t.push("Table blocks require headers and rows");break;case"list":s.list?.items&&Array.isArray(s.list.items)||t.push("List blocks require items array");break;case"callout":s.callout?.type&&s.callout?.content||t.push("Callout blocks require type and content");break;case"quote":s.quote?.text||t.push("Quote blocks require text");break;case"video":s.video?.url||t.push("Video blocks require a video URL");break;case"audio":s.audio?.url||t.push("Audio blocks require an audio URL")}return{isValid:0===t.length,errors:t}};e.s(["createQuizAttempt",()=>B,"getQuizQuestionById",()=>I,"getQuizQuestionsBySectionId",()=>P],99755);var k=e.i(43048);let I=async e=>(await o.db.select().from(i.quizQuestions).where((0,s.eq)(i.quizQuestions.id,e)).limit(1))[0]||null,P=async(e,r={})=>{let{questionType:n,includeUnpublished:c=!1,sortBy:a="orderIndex",sortOrder:u="asc"}=r,d=(0,s.eq)(i.quizQuestions.sectionId,e);n&&(d=(0,s.and)(d,(0,s.eq)(i.quizQuestions.questionType,n))),c||(d=(0,s.and)(d,(0,s.eq)(i.quizQuestions.isPublished,!0)));let l="desc"===u?(0,t.desc)(i.quizQuestions[a]):(0,t.asc)(i.quizQuestions[a]);return await o.db.select().from(i.quizQuestions).where(d).orderBy(l)},B=async e=>(await o.db.insert(k.quizAttempts).values({...e,attemptedAt:new Date}).returning())[0];e.s(["calculateCourseCompletionStatus",()=>U,"canUserAccessProgress",()=>D,"getUserProgressByUserAndSection",()=>f,"updateUserProgressByUserAndSection",()=>z,"upsertUserProgress",()=>v],66685);var x=e.i(29580);e.i(55923);let C=async e=>(await o.db.select().from(x.userProgress).where((0,s.eq)(x.userProgress.id,e)).limit(1))[0]||null,f=async(e,t)=>(await o.db.select().from(x.userProgress).where((0,s.and)((0,s.eq)(x.userProgress.userId,e),(0,s.eq)(x.userProgress.sectionId,t))).limit(1))[0]||null,Q=async(e,r={})=>{let{courseId:n,sectionId:c,isCompleted:i,completionPercentageMin:a,completionPercentageMax:u,dateFrom:d,dateTo:l,sortBy:g="lastAccessedAt",sortOrder:m="desc"}=r,q=(0,s.eq)(x.userProgress.userId,e);n&&(q=(0,s.and)(q,(0,s.eq)(x.userProgress.courseId,n))),c&&(q=(0,s.and)(q,(0,s.eq)(x.userProgress.sectionId,c))),void 0!==i&&(q=(0,s.and)(q,(0,s.eq)(x.userProgress.isCompleted,i))),void 0!==a&&(q=(0,s.and)(q,(0,s.gte)(x.userProgress.completionPercentage,a))),void 0!==u&&(q=(0,s.and)(q,(0,s.lte)(x.userProgress.completionPercentage,u))),d&&(q=(0,s.and)(q,(0,s.gte)(x.userProgress.lastAccessedAt,d))),l&&(q=(0,s.and)(q,(0,s.lte)(x.userProgress.lastAccessedAt,l)));let w="desc"===m?(0,t.desc)(x.userProgress[g]):(0,t.asc)(x.userProgress[g]);return await o.db.select().from(x.userProgress).where(q).orderBy(w)},v=async e=>(await o.db.insert(x.userProgress).values(e).onConflictDoUpdate({target:[x.userProgress.userId,x.userProgress.sectionId],set:{isCompleted:e.isCompleted,completionPercentage:e.completionPercentage,timeSpentSeconds:e.timeSpentSeconds,lastAccessedAt:e.lastAccessedAt,completedAt:e.completedAt,updatedAt:new Date}}).returning())[0],z=async(e,t,r)=>(await o.db.update(x.userProgress).set({...r,updatedAt:new Date}).where((0,s.and)((0,s.eq)(x.userProgress.userId,e),(0,s.eq)(x.userProgress.sectionId,t))).returning())[0]||null,U=async(e,t)=>{let r=await o.db.select().from(n.courseSections).where((0,s.eq)(n.courseSections.courseId,t));if(0===r.length)return null;let c=await Q(e,{courseId:t}),i=c.filter(e=>e.isCompleted).length,a=Math.round(i/r.length*100),u=c.reduce((e,s)=>e+s.timeSpentSeconds,0),d=c.length>0?c.reduce((e,s)=>s.lastAccessedAt>e?s.lastAccessedAt:e,c[0].lastAccessedAt):new Date,l=i===r.length&&r.length>0?c.reduce((e,s)=>s.completedAt&&s.completedAt>e?s.completedAt:e,c[0].completedAt||new Date(0)):void 0;return{courseId:t,userId:e,totalSections:r.length,completedSections:i,completionPercentage:a,timeSpentSeconds:u,lastAccessedAt:d,completedAt:l&&l.getTime()>0?l:void 0}},D=async(e,s,t)=>{let r=await C(e);return!!r&&(r.userId===s||"safety_admin"===t||"plant_manager"===t||"hr_admin"===t)}}];

//# sourceMappingURL=apps_safety-lms_src_lib_db_queries_course-sections_ts_8fe96409._.js.map